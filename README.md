# bitrix-pr.recrm

Ваш бизнес связан с недвижимостью? Это решение поможет Вам выгрузить информацию из ReCRM на сайт под системой 1С Битрикс.

ReCRM - современный, удобный комплекс инструментов для сотрудников агентств недвижимости и частных риэлторов, позволяющий в краткие сроки навести порядок в риэлторской компании и повысить ее прибыльность. 

<a href="http://01pr.ru/demo/recrm/" target="_blank">Demo</a> | <a href="http://marketplace.1c-bitrix.ru/solutions/pr.recrm/" target="_blank">Download</a>

<h3>О модуле</h3>
При помощи API предоставленной ReCRM, модуль выгружает выбранную Вами информацию в базу данных Вашего сайта на 1С Битрикс.<br>
Первую выгрузку Вы производите вручную, в дальнейшем можно настроить CRON (Планировщик задач), который будет в определенный Вами интервал времени обновлять информацию на сайте.<br>
<br>
Всю полученную информацию можно отобразить в разделе сайта при помощи комплексного компонента, который настраивается подобно стандартному компоненту "Битрикс - Новости".<br>
<br>
<b>В компонент входят настройки:</b><br>
<ul>
	<li>Список объектов</li>
	<li>Интерактивная Яндекс карта с расположением всех объектов</li>
	<li>Подробная информация объекта</li>
	<li>Сортировка и настройка отображения свойств объекта</li>
	<li>Отобразить карточку Агента</li>
	<li>Отобразить видео ролик YouTube</li>
	<li>Настроить SEO параметры из свойств объекта заданных в ReCRM</li>
	<li>Фотографии объекта и планировок</li>
	<li>Описание объекта</li>
	<li>и другие параметры.</li>
</ul>

<h3>Установка:</h3>
Решение устанавливается стандартно для Marketplace <a href="http://marketplace.1c-bitrix.ru/about/index.php">http://marketplace.1c-bitrix.ru/about/index.php</a><br>
После установки необходимо настроить модуль.<br>

<h3>Настройка модуля:</h3>
<ol>
	<li>В админ части сайта перейдите по вкладке: "Сервисы -&gt; ReCRM".</li>
	<li>В открывшемся окне справа выберите пункт "Настройки" и заполните следующие параметры:
		<ul>
			<li><u>Поле Ключ ReCrm:</u> запросите у поддержки ReCRM Api Key.</li>
			<li><u>Время одного шага при выгрузке (сек):</u> можно не менять, по умолчанию 30 сек.</li>
			<li><u>Ширина изображения в списке объектов:</u> какой ширины будут отображаться изображения объекта в списке, указывать только цифры в px</li>
			<li><u>Высота изображения в списке объектов:</u> какой высоты будут отображаться изображения объекта в списке, указывать только цифры в px</li>
			<li><u>Обрезать главное изображение точно по размеру:</u> нужно ли обрезать изображение, если его размеры непропорциональны желаемым</li>
			<li><u>Нужно ли накладывать водный знак на изображение:</u> для этого водный знак должен быть указан в настройках CRM</li>
			<li><u>Включить в выгрузку скрытые объекты:</u> те, которые не должны отображаться на сайте.</li>
			<li><u>Включить в выгрузку объекты со всеми статусами:</u> по умолчанию выгружаются объекты со статусом 0-активный, если включит эту опцию, в выгрузку будут добавлены объекты со статусом 1-успешный и 2-неудачный.</li>
			<li><u>Часовой пояс как в настройках ReCRM:</u> поле желательно заполнить, данные выгружаются учитывая время Вашего сайта и время аккаунта в ReCRM.</li>
			<li><u>Какие данные выгружать из ReCRM:</u> Выберите, какие данные вам необходимы. Для нормальной работы модуля достаточно выбрать: "Объекты недвижимости" и "Агенты"</li>
			<li><u>Вырезать из описания строку:</u> Бывает в описании объекта расположен текст, который необходимо не отображать на сайте. Укажите его в этом поле.</li>
			<li><u>Дата последнего обращения к CRM (unixtime):</u> редактировать не рекомендуется, но вы можете поставить 0 когда хотите по новой выгрузить все объекты из ReCrm.</li>
			<li><u>Дата последнего обновления (unixtime):</u> редактировать не рекомендуется, но вы можете поставить 0 когда хотите по новой выгрузить все объекты из ReCrm.</li>
			<li><u>Список инфоблоков для данных:</u> для каждого выбранного Вами типа данных, которые необходимо выгрузить, выберите соответствующий инфоблок. Рекомендуем для каждого типа создать свой отдельный инфоблок.</li>
		</ul>
	</li>
	<li>После настроек модуля произведите первую выгрузку. Кнопка выгрузки расположена во вкладке "Статистика".<br> Если вы выгружаете данные вручную, создайте задание для импорта при помощи кнопки <i>"Запросить данные из ReCRM вручную и добавить в очередь для выгрузки"</i>, Время импорта зависит от количества выгружаемых данных.<br> После успешного создания временного файла Вы можете загрузить все полученные данные в базу данных Вашего сайта при помощи кнопки: "Загрузить все полученные данные в базу данных сайта"</li>
	<li>После завершения  выгрузки, вам необходимо настроить свойства. Перейдите по вкладке "Настройка свойств". В списке отображены все свойства объекта, которые были указаны в ReCRM.
		<ul>
			<li>Название: видит посетитель на сайте</li>
			<li>Ед. изм: отображается после значения свойства, например у цены будет руб.</li>
			<li>Сорт.: в каком порядке отображать свойства. Вы можете изменить порядок свойств при помощи мыши перетаскивая их друг за другом.</li>
		</ul>
		Нажмите кнопку Сохранить в низу списка.
	</li>
	<li>Для настройки автоматической выгрузку Вам необходимо обратиться к поддержке хостинга Вашего сайта с просьбой: "Необходимо поставить задачу в CRON по расписанию: 'каждые 6 часов' для файла на сервере нашего сайта в папке: /bitrix/modules/pr.recrm/cron.php"</li>
</ol>


<h3>Настройка компонента:</h3>

Компонент имеет минимальное стилистическое оформление. Размеры макетов адаптируются под ширину Вашего сайта.<br><br>
<ol>
	<li>Перейдите на главную страницу вашего сайта.</li>
	<li>Создайте новый раздел, например ReCRM.</li>
	<li>При помощи визуального редактора разместите компонент "Объекты ReCRM", который расположен в привычном для Битриса месте. Компонент находится в папке ПраймВеб. Если вы не увидели компонент, обновите список компонентов.</li>
	<li>Настройте компонент так, как вам нужно. Большинство настроек схожи с параметрами стандартного комплексного компонента Новости.</li>
</ol>

<h3>Расширение модуля:</h3>

Модуль имеет ряд событий и функций, которые позволяют управлять выгружаемыми данными или перенаправлять пользователя по короткой ссылке к объекту.<br>
<br>
<strong>Событие OnBeforeImport</strong><br>
Срабатывает перед обновлением/добавлением каждого объекта в БД 1С-Битрикс. Событие размещено в классе prReCrmData в файле /classes/general/prReCrmData.class.php<br>
<br>
<i>Событие содержит массив данных:</i><br>
TYPE (text) - тип выгружаемого объекта<br>
NEW (bool) - новый или обновляемый объект<br>
PARAMS (array) - массив с данными (MODIFIED_BY, IBLOCK_ID, NAME, CODE, DETAIL_TEXT, DETAIL_TEXT_TYPE)<br>
PROP (array) - массив со свойствами элемента где ключ - имя свойства, значение - значение.<br>
<br>
<i>Должно вернуть массив с:</i><br>
PARAMS (array) - параметры элемента<br>
PROPS (array) - свойства для элемента<br>
<br>
Например, мы хотим у объектов типа estate добавить свое свойство "на лету" во время выгрузки. Создайте свойство в свойствах инфоблока для объектов и разместите в файле bitrix/php_interface/init.php код:

<pre>
AddEventHandler("pr.recrm", "OnBeforeImport", "MyReCRMOnBeforeImport");
function MyReCRMOnBeforeImport($arData = array())
{
	$arResult = $arData;
	if($arResult['TYPE'] == 'estate')
	{
		/* Добавим в свойство MyCustomField стоимость price_total + 18% */
		$arResult['PROP']['MyCustomField'] = $arResult['PROP']['price_total'] * 1.18;
	}

	return $arResult;
}
</pre>

<strong>Событие OnBeforeTypes</strong><br>
Позволяет расширить типы сущностей выгружаемых из ReCRM. Событие размещено в классе prReCrmProps в файле /classes/general/prReCrmProps.class.php<br>
<br>
<i>Событие содержит массив данных:</i><br>
url (array) - ключ - тип, значение - url для запроса к api<br>
arr (array) - ключ - тип, значение - поля для формирования массива данных из ответа от API<br>
name (array) - ключ - тип, значение - название<br>
<br>
<i>Должно вернуть массив с новым добавленным типом.<br>
<br>

<strong>Событие OnAfterImport</strong><br>
Срабатывает после всей выгрузки выбранных объектов. Событие размещено в классе prReCrmData в файле /classes/general/prReCrmData.class.php<br>
<br>
Может быть использовано для сброса кеша:<br>

<pre>
AddEventHandler("pr.recrm", "OnAfterImport", "prOnAfterImport");
function prOnAfterImport()
{
	BXClearCache(true, "/s1/pr/");
}
</pre>
<br>

<strong>Событие OnBeforeGetSettings </strong><br>
Срабатывает перед тем, как передать параметры модуля, которые заполнены во вкладке "Настройки". Событие размещено в классе prReCrmData в файле /classes/general/prReCrmData.class.php<br>
<br>
Может быть использовано для переопределения параметров перед выгрузкой:<br>
<br>
<i>Событие содержит массив данных:</i><br>
TYPE (text) - тип параметра, если запрошен только 1 параметр<br>
PARAMS (array) - массив с параметрами<br>
<br>
<i>Должно вернуть массив.<br>
<br>
<pre>
AddEventHandler("pr.recrm", "OnBeforeGetSettings", "prOnBeforeGetSettings");
function prOnBeforeGetSettings($arData = array())
{
	$arResult = $arData;

	$arResult['PARAMS']['pr_recrm_key']  = 'demo'; // определяем новый ключ

	return $arResult;
}
</pre>
<br>

<strong>Короткие ссылки $prReCrmProps->redirect()</strong><br>
Позволяет перенаправить пользователя по ссылке вида http://site.ru/?recrm=12345 на страницу объекта. Метод размещен в классе prReCrmData в файле /classes/general/prReCrmData.class.php<br>
<br>
<i>Параметры:</i><br>
GET recrm - содержит ID объекта из ReCRM<br>
Редирект происходит на страницу DETAIL_PAGE_URL, шаблон которой задан в настройках инфоблока для объектов<br>
<br>
Для работы необходимо в файле bitrix/php_interface/init.php разместить код:
<pre>
/* ReCRM Redirect */
AddEventHandler('main', 'OnBeforeProlog', 'ReCRM_redirect',1);
function ReCRM_redirect()
{
	CModule::IncludeModule("pr.recrm");
	$prReCrmData = new prReCrmData;
	$prReCrmData->redirect();
}
</pre>

<br>

<strong>Вспомогательные константы</strong><br>
Константы можно определить в init.php<br>
<i>PR_RECRM_CLOSE</i> - если константа определена, содержимое константы будет отображено на месте кнопок для выгрузки во вкладке "Статистика". Например, если необходимо ограничить выгрузку только по CRON.<br>
<i>PR_RECRM_CLOSE_OPTIONS</i> - если константа определена, содержимое константы будет отображено в верхней части вкладки "Настройки".<br>
<i>PR_RECRM_DEBUG</i> - если константа определена, в лог файл (AddMessage2Log) будут добавлены все шаги процесса выгрузки.<br>